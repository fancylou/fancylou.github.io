---
layout: post
title: "Flutter å­¦ä¹ 4ï¼šé›†æˆåˆ°åŸæœ‰çš„é¡¹ç›®ä¸­"
categories: flutter
date: 2018-12-09 14:10:00
---

è¿™ä¸ªæ˜¯æˆ‘å­¦ä¹ Flutterçš„ä¸€ä¸ªç³»åˆ—æ–‡ç« ï¼š
1. [Flutter å­¦ä¹ 1ï¼šå¼€å‘ç¯å¢ƒã€å¼€å‘å·¥å…·ã€åˆå§‹åŒ–ä¸€ä¸ªé¡¹ç›®](http://www.muliba.net/ios/android/2018/11/16/Flutter-%E5%AD%A6%E4%B9%A0-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83-%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7-%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE.html)
2. [Flutter å­¦ä¹ 2ï¼šä»main.dartæ–‡ä»¶è¯´èµ·](http://www.muliba.net/flutter/2018/11/23/Flutter-%E5%AD%A6%E4%B9%A0-%E4%BB%8Emain.dart%E6%96%87%E4%BB%B6%E8%AF%B4%E8%B5%B7.html)
3. [Flutter å­¦ä¹ 3ï¼šè½¬åœºã€å¯¼èˆª](http://www.muliba.net/flutter/2018/12/04/Flutter-%E5%AD%A6%E4%B9%A03-%E8%BD%AC%E5%9C%BA-%E5%AF%BC%E8%88%AA.html)
4. Flutter å­¦ä¹ 4ï¼šé›†æˆåˆ°åŸæœ‰çš„é¡¹ç›®ä¸­


ä»å‰é¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘è§‰å¾—å¦‚æœç”¨Flutterå¼€å‘ä¸€ä¸ªå…¨æ–°çš„Appåº”è¯¥è¿˜æ˜¯é—®é¢˜ä¸å¤§çš„ã€‚å®ƒçš„ä¼˜åŠ¿åœ¨äºUIç»Ÿä¸€ï¼Œå¯ä»¥ç”¨ä¸€å¥—UIé€‚ç”¨ä¸¤ç«¯ï¼ŒèŠ‚çœå¼€å‘æˆæœ¬ã€‚ä½†æ˜¯ä¹Ÿæœ‰é—®é¢˜æ˜¯æ¯•ç«Ÿæ˜¯æ–°çš„å¤šç«¯èåˆæ–¹æ¡ˆï¼Œè¿˜æœ‰å¾ˆå¤šå¤§ç¯å¢ƒçš„ä¸æ”¯æŒï¼Œæ¯”å¦‚ç¬¬ä¸‰æ–¹SDKå¦‚ä½•é›†æˆç­‰é—®é¢˜ã€‚
å¦‚æœæ˜¯å·²ç»æœ‰çš„é¡¹ç›®å‘¢ï¼Œèƒ½å¤Ÿé›†æˆFlutterå—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼[å®˜æ–¹æœ‰ä¸ªwiki](https://github.com/flutter/flutter/wiki/Add-Flutter-to-existing-apps)å°±æ˜¯ä»‹ç»è¿™ä¸ªçš„ã€‚
## IOS
### åˆ›å»ºä¸€ä¸ªFlutteræ¨¡å—
é¦–å…ˆè¦æŠŠFlutteræ¨¡å—å»ºèµ·æ¥ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å‘½ä»¤æ¥åˆ›å»ºæ¨¡å—ï¼š
```shell
$ cd some/path/
$ flutter create -t module ff_flutter
```
è¿™é‡Œçš„some pathå°±æ˜¯ä½ åŸæ¥é¡¹ç›®çš„çˆ¶ç›®å½•ï¼Œæ•²å®Œå‘½ä»¤åçš„ç›®å½•ç»“æ„å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

```yaml
some/path/
    MyOldApp/
        MyOldApp/
                AppDelegate.swift
    ff_flutter/
        lib/main.dart
        .ios/
```

### ä¿®æ”¹Podfileæ–‡ä»¶ï¼Œæ·»åŠ Flutteræ¨¡å—åˆ°IOSé¡¹ç›®ä¸­
æ¥ä¸‹æ¥ï¼Œåœ¨åŸæ¥çš„é¡¹ç›®çš„Podfileä¸­æ·»åŠ ä¸¤å¥è¯ï¼š

```Ruby
target 'MyOldApp' do
  use_frameworks!
  pod 'Moya', '~> 12.0'
  ....
  flutter_application_path = 'some/path/ff_flutter/'
  eval(File.read(File.join(flutter_application_path, '.ios', 'Flutter', 'podhelper.rb')), binding)
  
end
```
ç„¶åè·Ÿä½ ä»¥å‰åœ¨Podfileä¸­æ·»åŠ å®Œç¬¬ä¸‰æ–¹åº“ä¸€æ ·ï¼Œéœ€è¦åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä¸€ä¸‹podå‘½ä»¤ï¼š

```shell
pod install
```
æ‰“å¼€`MyOldApp.xcworkspace`æ–‡ä»¶ï¼Œåœ¨xcodeä¸­ä¿®æ”¹ä¸¤ä¸ªåœ°æ–¹ã€‚
ä¸€ä¸ªæ˜¯Flutterä¸æ”¯æŒbitcodeï¼Œéœ€è¦æŠŠbitcodeå…³é—­ã€‚
![](http://img.muliba.net/post/20181209142621.png)
å¦å¤–ä¸€ä¸ªæ˜¯åœ¨`Build Phases`ä¸­æ·»åŠ ä¸€ä¸ªè„šæœ¬ï¼Œç‚¹å‡»`Build Phases `æ ‡ç­¾ï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„â•å·ï¼Œé€‰æ‹©`New Run Script Phase`ã€‚
![](http://img.muliba.net/post/20181209145434.png)
ç„¶ååœ¨æ–°ç”Ÿæˆçš„`Run Script`é¡¹ä¸­çš„è„šæœ¬æ¡†å†…æ·»åŠ ä¸¤è¡Œä»£ç ï¼š
![](http://img.muliba.net/post/20181209145440.png)

```shell
"$FLUTTER_ROOT/packages/flutter_tools/bin/xcode_backend.sh" build
"$FLUTTER_ROOT/packages/flutter_tools/bin/xcode_backend.sh" embed
```
å…¨éƒ¨é…ç½®å®Œæˆåï¼Œå°†IOSé¡¹ç›®è¿›è¡ŒBuildï¼ˆcommand+Bï¼‰æ“ä½œã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæ²¡æœ‰å¼‚å¸¸ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ·»åŠ ä»£ç äº†ã€‚

### ä¿®æ”¹IOSä»£ç 
é€šè¿‡ä¸Šé¢é…ç½®å’Œæ„å»ºæ¨¡å—ï¼Œç°åœ¨IOSé¡¹ç›®ä¸­å·²ç»å¼•å…¥äº†flutteræ¨¡å—äº†ã€‚æˆ‘ä»¬è¿˜éœ€è¦åœ¨AppDeletegateä¸­å¼•å…¥ä»£ç ã€‚

```swift
import UIKit
import Flutter
import FlutterPluginRegistrant

@UIApplicationMain
class AppDelegate: FlutterAppDelegate {
    override func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        GeneratedPluginRegistrant.register(with: self);
        return super.application(application, didFinishLaunchingWithOptions: launchOptions);
    }
    }
```
åŸæ¥çš„é¡¹ç›®ä¸­å¦‚ä½•æ‰“å¼€è¿™ä¸ªFlutterå†™çš„åŠŸèƒ½é¡µé¢å‘¢ï¼ŒFlutteræœ‰ä¸ªå…¥å£`FlutterViewController`ã€‚
æˆ‘åœ¨åŸæ¥é¡¹ç›®çš„ä¸€ä¸ªControllerä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼š

```swift
self.navigationItem.rightBarButtonItem = UIBarButtonItem(title: "Flutter", style: .plain, target: self, action: #selector(toFlutter))
 ...
@objc func toFlutter()  {
        let flutterViewController = FlutterViewController()
        self.present(flutterViewController, animated: false, completion: nil)
    }
```

![](http://img.muliba.net/post/20181209142616.png)

ç‚¹å‡»è¿™ä¸ªFlutteræŒ‰é’®ï¼Œå°±å‡ºç°äº†æˆ‘ä»¬å¾ˆç†Ÿæ‚‰çš„é‚£ä¸ªFlutter Demoçš„ç”»é¢ï¼š

![](http://img.muliba.net/post/Screen Shot 2018-11-16 at 13.04.51.png-500.500)

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¦‚ä½•å›åˆ°åŸæ¥çš„UIViewContollerå‘¢ï¼Ÿæˆ‘ä»¬ä¿®æ”¹ä¸‹è¿™ä¸ªåŠ å·æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼š

```dart
//é¡¶éƒ¨å¼•å…¥servicesåŒ…
import 'package:flutter/services.dart';

//ä¿®æ”¹åŠ å·æŒ‰é’®çš„äº‹ä»¶å‡½æ•°
void _incrementCounter() {
    SystemNavigator.pop();
}
```
è¿™æ—¶å€™é—®é¢˜æ¥äº†ï¼Œç‚¹å‡»äº†æ²¡ååº”ã€‚æ²¡æœ‰æˆ‘ä»¬é¢„æƒ³çš„é‚£æ ·å…³é—­äº†å½“å‰çš„`FlutterViewController`ã€‚åæ¥æŸ¥äº†å‘ç°è¿™ä¸ªæ–¹å¼åœ¨Androidæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯IOSæœ‰é—®é¢˜ï¼Œé—®é¢˜åœ¨äºæ‰“å¼€`FlutterViewController`çš„æ–¹å¼ï¼Œå¦‚æœæ˜¯Navigation Controller ç”¨ï¼š

```swift
self.navigationController?.pushViewController(flutterViewController, animated: false)
```
è¿™ç§æ–¹å¼æ‰“å¼€çš„`FlutterViewController`ï¼Œé‚£ç”¨ä¸Šé¢é‚£ç§å½¢å¼æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚
ä½†æ˜¯ç”¨ï¼š

```swift
self.present(flutterViewController, animated: false, completion: nil)
```
è¿™ç§æ–¹å¼æ‰“å¼€çš„å°±ä¸è¡Œäº†ã€‚
åæ¥æˆ‘ç”¨äº†å¦å¤–ä¸€ç§æ€è·¯æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
### Flutterè°ƒç”¨Nativeç«¯çš„ä»£ç 
Flutterè°ƒç”¨Nativeç«¯çš„ä»£ç æ˜¯Flutterå®˜æ–¹æä¾›çš„ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…èƒ½å¤Ÿè·å–Nativeç«¯è°ƒç”¨ç¡¬ä»¶ä¿¡æ¯ç­‰æƒ…å†µå¯ä»¥ä½¿ç”¨çš„ã€‚æ–¹å¼å°±æ˜¯åœ¨Nativeç«¯åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œç„¶ååœ¨Flutterç«¯çš„Dartä»£ç æ‰§è¡Œä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨Nativeç«¯é€šè¿‡ä¸€ä¸ªæ–¹æ³•åå­—å¯¹åº”ï¼Œæ‰§è¡Œä¸€æ®µNativeçš„ä»£ç ã€‚
#### Flutterç«¯dartä»£ç 

```dart
class _MyHomePageState extends State<MyHomePage> {
  int _counter = 0;
  //åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œé€šé“çš„nameå­—ç¬¦ä¸²è¦å’ŒNativeç«¯çš„ä¸€æ ·
  static const methodChannel = const MethodChannel('your.package/native_get');
  void _incrementCounter() {
    if(Platform.isIOS){
    //æ‰§è¡ŒNativeç«¯çš„ä¸€ä¸ªæ–¹æ³•ï¼Œkeyæ˜¯colseSelf
      methodChannel.invokeMethod('closeSelf');
    }else if(Platform.isAndroid){
      SystemNavigator.pop();
    }
 }
...
}
```
#### Nativeç«¯swiftä»£ç 
```swift
    @objc func toFlutter()  {
        let flutterViewController = FlutterViewController()
        //è¿™é‡Œçš„channelNameå’ŒFlutterç«¯çš„é‚£ä¸ªnameä¸€æ ·
        let channelName = "your.package/native_get"
        let messagechannel = FlutterMethodChannel.init(name: channelName, binaryMessenger: flutterViewController)
        messagechannel.setMethodCallHandler { (methodCall, result) in
            if methodCall.method == "closeSelf" {
                self.closeSelf()
            }
        }
        self.present(flutterViewController, animated: false, completion: nil)
    }
    
    private func closeSelf() {
        self.dismiss(animated: false, completion: nil)
    }

```

ç°åœ¨å°±okäº†ï¼Œå†ç‚¹å‡»é‚£ä¸ªåŠ å·æŒ‰é’®ï¼Œå°±ä¼šå…³é—­å½“å‰çš„é¡µé¢äº†ï¼ğŸ˜„

## Android

### åˆ›å»ºä¸€ä¸ªFlutteræ¨¡å—
é¦–å…ˆè¦æŠŠFlutteræ¨¡å—å»ºèµ·æ¥ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å‘½ä»¤æ¥åˆ›å»ºæ¨¡å—ï¼š

```shell
$ cd some/path/
$ flutter create -t module ff_flutter
```
è¿™é‡Œçš„some pathå°±æ˜¯ä½ åŸæ¥é¡¹ç›®çš„çˆ¶ç›®å½•ï¼Œæ•²å®Œå‘½ä»¤åçš„ç›®å½•ç»“æ„å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š

```yaml
some/path/
    MyOldApp/
        app/
            build.gradle
            ...
        settings.gradle
        gradle.properties
        ...
    ff_flutter/
        lib/main.dart
        .android/
```
### ä¿®æ”¹Androidé¡¹ç›®çš„é…ç½®ï¼Œå¼•å…¥Flutteræ¨¡å—

```groove
include ':app'                                     // è¿™å¥æ˜¯åŸæ¥å°±åœ¨çš„ï¼Œä¸‹é¢çš„å‡ å¥æ˜¯éœ€è¦æ·»åŠ çš„
setBinding(new Binding([gradle: this]))                                 
evaluate(new File(                                                      
  settingsDir.parentFile,                                               
  'ff_flutter/.android/include_flutter.groovy'                      
))    
```
è¿™ä¸ªé…ç½®æ·»åŠ åï¼Œå°±æ˜¯æŠŠé‚£ä¸ªæ–°å»ºçš„Flutteræ¨¡å—å¼•å…¥åˆ°å½“å‰çš„Androidé¡¹ç›®ä¸­ï¼Œå†åˆ°`app`æ¨¡å—ä¸­ï¼Œä¹Ÿå°±æ˜¯ä½ Androidé¡¹ç›®çš„ä¸»æ¨¡å—ä¸­çš„`build.gradle`æ–‡ä»¶ä¸­æ·»åŠ è¿™ä¸ªFlutteræ¨¡å—çš„ä¾èµ–ï¼š

```groove
dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    ...
    //æ·»åŠ flutteræ¨¡å—ä¾èµ–
    implementation project(':flutter')
}
```
### ä¿®æ”¹Androidä»£ç 
ä¸Šé¢æŠŠflutteræ¨¡å—å¼•å…¥åå°±å¯ä»¥è°ƒç”¨äº†ï¼Œåœ¨Androidä»£ç ä¸­ï¼ŒFlutteræä¾›äº†ä¸¤ç§æ–¹å¼å¼•å…¥Flutteré¡µé¢ï¼Œä¸€ç§æ˜¯`Flutter.createView`ï¼Œä¸€ç§æ˜¯`Flutter.createFragment`ã€‚
1. Flutter.createView
kotlinä»£ç ï¼š

```kotlin
 val view = Flutter.createView(this, lifecycle, "/")
 setContentView(view)
```
1. Flutter.createFragment 
kotlinä»£ç ï¼š

```kotlin
 setContentView(R.layout.activity_flutter)
 val tx = supportFragmentManager.beginTransaction()
 tx.replace(R.id.container, Flutter.createFragment("/"))
 tx.commit()
```
è¿™ä¸Šé¢ä¸¤ç§æ–¹å¼ä¸€ç§æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªViewï¼Œä¸€ç§æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªFragmentï¼Œå…·ä½“ç”¨å“ªç§å°±çœ‹è‡ªå·±æ€ä¹ˆæ–¹ä¾¿å§ã€‚è¿˜æœ‰å°±æ˜¯ä¸Šé¢ä¸¤ä¸ªcreateæ–¹æ³•éƒ½ä¼ å…¥äº†ä¸€ä¸ª***æ–œæ å­—ç¬¦ä¸²***ï¼Œè¿™ä¸ªæ˜¯Flutteré‡Œé¢çš„è·¯ç”±ï¼Œå°±è·ŸH5å¼€å‘ä¸­ç»å¸¸ç”¨çš„è·¯ç”±ä¸€æ ·çš„é“ç†ã€‚

çœ‹çœ‹Flutterçš„ä»£ç ï¼š

```dart
void main() => runApp(MaterialApp(
      title: 'Flutter Demo',
      theme: ThemeData(
        primarySwatch: Colors.blue,
      ),
      initialRoute: '/',
      routes: {
        '/': (context) => MyHomePage(title: 'Flutter Demo Home Page')
      },
    ));
```
è¿™é‡ŒæŠŠåŸæ¥demoä¸­çš„homeå»æ‰äº†ï¼Œæ¢æˆäº†`initialRoute`å’Œ`routes`ã€‚`initialRoute`å®šä¹‰æ‰“å¼€Flutter Appçš„æ—¶å€™ç¬¬ä¸€ä¸ªé¡µé¢æ˜¯å“ªä¸ªè·¯ç”±è·¯å¾„ã€‚`routes`å°±æ˜¯å½“å‰æœ‰å“ªäº›è·¯ç”±ã€‚æ‰€ä»¥å‰é¢Androidä»£ç ä¸­`Flutter.createView`å’Œ`Flutter.createFragment`åˆ›å»ºå‡ºæ¥çš„UIå†…å®¹å°±æ˜¯è¿™ä¸ª`MyHomePage`çš„å†…å®¹ã€‚

| ![](http://img.muliba.net/post/20181209214953.png-500.500) | -> |![](http://img.muliba.net/post/20181209214930.png-500.500) |
| --- | --- | --- |


## çƒ­æ›´æ–°
å‰é¢ä¹Ÿæåˆ°Flutterå¯ä»¥çƒ­æ›´æ–°ï¼Œè¿™ç§é›†æˆåˆ°åŸæœ‰çš„Nativeé¡¹ç›®ä¸­çš„æ–¹å¼ä¹Ÿå¯ä»¥çƒ­æ›´æ–°ã€‚
é¦–å…ˆè¿›å…¥åˆšæ‰åˆ›å»ºçš„Flutteræ¨¡å—ç›®å½•ï¼š

```shell
$ cd some/path/ff_flutter
$ flutter attach
Waiting for a connection from Flutter on KNT AL20...
```
ç„¶ååœ¨ä½ çš„IDEä¸­ç”¨debugæ¨¡å¼å¯åŠ¨Appï¼Œç„¶åæ‰“å¼€è¿™ä¸ªFlutterçš„é¡µé¢çš„æ—¶å€™ä½ çš„å‘½ä»¤è¡Œç•Œé¢å°±ä¼šå‡ºç°ä¸‹é¢çš„å­—æ ·ï¼š

```shell
Done.
Syncing files to device KNT AL20...                          1.4s

ğŸ”¥  To hot reload changes while running, press "r". To hot restart (and rebuild
state), press "R".
An Observatory debugger and profiler on KNT AL20 is available at:
http://127.0.0.1:60711/
For a more detailed help message, press "h". To detach, press "d"; to quit,
press "q".
```
ç„¶åä½ å¦‚æœä¿®æ”¹äº†Flutterç«¯çš„UIç•Œé¢ï¼Œåœ¨å‘½ä»¤è¡Œç»ˆç«¯æ•²ä¸€ä¸ª`r`ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨åˆ·æ–°é¡µé¢ã€‚æ¯”å¦‚ä¸Šé¢çš„é¡µé¢ä¸ºæŠŠ**æµ‹è¯•**è¿™ä¸¤ä¸ªä¸­æ–‡å­—åˆ é™¤æ‰ã€‚

```shell
Initializing hot reload...
Reloaded 1 of 419 libraries in 1,048ms.
```

![](http://img.muliba.net/post/20181209220355.png-500.500)


The End !





